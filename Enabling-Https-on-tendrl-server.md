# Enabling HTTPS for Tendrl-UI, Tendrl-API and Grafana

This wikipage describes how to set up SSL access for Tendrl Web UI, Tendrl REST
API and Grafana based dashboard.

## Overview of the solution

* Tendrl Web, API and Grafana dashboard, which are provided by apache server,
  will be secured with SSL by reconfiguration of apache.
* Access to unencrypted http port is redirected to encrypted https port.
* Tendrl contains sample configuration files for apache to simplify the SSL
  setup.
* Nothing else is secured or restricted compared to default setup without
  HTTPS enabled.

## Pre-requisites:

* Package `mod_ssl` is installed and the default configuration
  in `/etc/httpd/conf.d/ssl.conf` is left unmodified.

* SSL key and certificate files are deployed on the Tendrl server.
  For testing purposes, one can use local self signed key and certificate
  pair created during installation of `mod_ssl` package (file paths for this
  option are used as a default in tendrl ssl sample config file).

## Known Limitations

* Access to Grafana dashboard is not authenticated, so that anyone who can
  access Tendrl web login page can also access and read all panels in Tendrl
  dashboard without any password (and learn about cluster structure, current
  workload and historic trends). This is happening because Tendrl uses
  anonymous access to Grafana main dashboard.

* Tendrl server is listening on few other ports, which are not secured and
  which are needed for internal communication (eg. to receive gluster hooks or
  metrics data from storage machines). The only other component of Tendrl stack
  which can be protected via SSL is Etcd, as described in wikipage
  [Etcd SSL enabling using tendrl-ansible](https://github.com/Tendrl/documentation/wiki/Etcd-SSL-configuration-using-tendrl-ansible).

* This configuration file avoids modification to any of the configuration files
  installed by system packages. As such, this configuration file can only serve
  the scenarios where the requests are served over a specific ip address. If
  this is undesirable, the `VirtualHost` for `_default_:443` needs to be
  commented out in `/etc/httpd/conf.d/ssl.conf` (which is installed by the
  `mod_ssl` package) and the `%ssl_virtualhost_ip%` in both these files needs
  to be changed to `_default_`.
  Please refer to the [apache
  wiki](https://wiki.apache.org/httpd/NameBasedSSLVHosts) for more details.
  TODO: this needs to be updated wrt recent fixes (prefix, ip/hostname change)

## Deployment Instructions

On a machine where Tendrl server is installed, perform the following steps:

1. Make sure `mod_ssl` rpm package is installed and
   `/etc/httpd/conf.d/ssl.conf` file is not modified:

   ```
   # rpm -V mod_ssl
   #
   ```

1. Create new `tendrl-ssl.conf` file using the sample configuration file:

   ```
   # cp /etc/httpd/conf.d/tendrl-ssl.conf.sample /etc/httpd/conf.d/tendrl-ssl.conf
   ```

   TODO: use correct prefix

1. Make the following changes to the `tendrl-ssl.conf` file:

	* Replace `%ssl_virtualhost_ip%` with ip address of Tendrl server.
	* Set `ServerName` to hostname (fqdn) of Tendrl server.
	* Edit the file path for the `SSLCertificateFile` variable if you want to
      use your own certificate instead of
	  default self-signed `/etc/pki/tls/certs/localhost.crt` generated by
      `mod_ssl`.
	* Edit the file path for the `SSLCertificateKeyFile` variable if you have
      changed cert file in the previous step.
	  The default value points to `/etc/pki/tls/private/localhost.key` file
      generated by `mod_ssl`.

1. Make the following changes to the `tendrl.conf` file (this is necessary for
   http redirection to work):

	* Replace `%ssl_virtualhost_ip%` with hostname (fqdn) of Tendrl server.
      TODO: [issue #460](https://github.com/Tendrl/api/issues/460)
	* Un-comment the line which has the `Redirect` rule (this line has been
      edited in the previous step).
	* Comment out the lines which have the `DocumentRoot`, `ProxyPass` and
	  `ProxyPassReverse` directives.

1. Thereafter, check if the configuration is valid using `apachectl -t` and
reload httpd using `systemctl reload httpd.service`.

1. Make sure https port is open:

   ```
   # firewall-cmd --add-service=https
   # firewall-cmd --add-service=https --permanent
   ```

See [Firewall Configuration]() section for more details.

Note: If you have a web browser open with Tendrl web during this procedure and
you use default self signed SSL certificates, your browser won't be able to
display Tendrl web correctly and you will need to TODO reload/restart it to
be able to access Tendrl web. In normal cases when you use custom certificate
signed with CA which is already trusted by your browser, the transition is
smooth, without any distruptions.
